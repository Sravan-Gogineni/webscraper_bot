{% extends "base.html" %}
{% block title %}Yocket Programs | OneGrad{% endblock %}
{% block content %}
<section class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h2 style="margin: 0;">Yocket Programs{% if total_count is defined %} <span style="font-size: 1rem; font-weight: normal; color: #666;">({{ total_count }})</span>{% endif %}</h2>
      <p style="margin: 0.25rem 0 0;">View programs from Yocket API grouped by university.</p>
    </div>
  </div>
  
  <!-- Search Bar -->
  <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fb; border: 1px solid #d7dff3; border-radius: 8px;">
    <form method="get" action="{{ url_for('forms.yocket_programs_list') }}" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 250px;">
        <label for="search" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1d2e53;">Search Universities:</label>
        <input 
          type="text" 
          id="search" 
          name="search" 
          value="{{ search_query or '' }}" 
          placeholder="Enter university name or ID..."
          style="width: 100%; padding: 0.65rem; border: 1px solid #d7dff3; border-radius: 6px; font-size: 0.95rem;"
        >
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
        <button 
          type="submit" 
          style="padding: 0.65rem 1.5rem; background: #2f4f8f; color: #fff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
          Search
        </button>
        {% if search_query %}
        <a 
          href="{{ url_for('forms.yocket_programs_list', per_page=per_page) }}" 
          style="padding: 0.65rem 1.5rem; background: #6c757d; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.95rem;">
          Clear
        </a>
        {% endif %}
      </div>
      <!-- Preserve per_page in form -->
      <input type="hidden" name="per_page" value="{{ per_page }}">
    </form>
    {% if search_query %}
    <div style="margin-top: 0.75rem; color: #666; font-size: 0.9rem;">
      <strong>Search results for:</strong> "{{ search_query }}" - Found {{ total_universities }} universit{{ 'y' if total_universities == 1 else 'ies' }}
    </div>
    {% endif %}
  </div>
  {% if not grouped_programs or not grouped_programs.items() %}
  <p style="margin-top: 1.5rem;">No Yocket programs found.</p>
  {% else %}
  <div style="margin-top: 2rem;">
    {% for university_name, program_rows in grouped_programs.items() %}
    <!-- University Section -->
    <div class="university-section" data-university-name="{{ university_name }}" style="background: #f8f9fb; border: 2px solid #3e6acb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div>
          <h3 style="margin: 0 0 0.5rem 0; color: #1d2e53; font-size: 1.2rem; font-weight: 700;">
            {{ university_name }}
          </h3>
          <p style="margin: 0; color: #7b86aa; font-size: 0.9rem;">
            {{ program_rows|length }} program{{ 's' if program_rows|length != 1 else '' }}
            {% if program_rows[0].UniversityID %}
            <span style="color: #999;">(ID: {{ program_rows[0].UniversityID }})</span>
            {% endif %}
          </p>
        </div>
        <form method="POST" action="{{ url_for('forms.yocket_programs_delete_university', page=page, per_page=per_page, search=search_query) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete ALL {{ program_rows|length }} program{{ 's' if program_rows|length != 1 else '' }} for {{ university_name }}? This action cannot be undone.');">
          <input type="hidden" name="university_slug" value="{{ university_name }}">
          {% if program_rows[0].UniversityID %}
          <input type="hidden" name="university_id" value="{{ program_rows[0].UniversityID }}">
          {% endif %}
          <button type="submit" style="padding: 0.5rem 1rem; background: #dc3545; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: background 0.2s ease; white-space: nowrap;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
            Delete All Programs
          </button>
        </form>
      </div>
      
      <!-- Programs Table for this University -->
      <div style="overflow-x: auto;">
        <table
          class="yocket-programs-table"
          style="
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.95rem;
            background: #ffffff;
            border-radius: 6px;
            overflow: hidden;
          "
        >
          <thead>
            <tr style="background-color: #eef3ff; text-align: left;">
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Course Name</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Credential</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">School</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Level</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Duration</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Tuition Fee</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Partner</th>
            </tr>
          </thead>
          <tbody>
            {% for row in program_rows %}
            <tr style="border-bottom: 1px solid #e4e9f5;">
              <td style="padding: 0.65rem; font-weight: 600;">{{ row.UniversityCourseName or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.Credential or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.SchoolName or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.CourseLevel or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.Duration or "—" }}{% if row.Duration %} months{% endif %}</td>
              <td style="padding: 0.65rem;">
                {% if row.ActualTuitionFee %}
                  ${{ "{:,.0f}".format(row.ActualTuitionFee) }}
                {% elif row.ConvertedTuitionFee %}
                  ${{ "{:,.0f}".format(row.ConvertedTuitionFee) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding: 0.65rem;">
                {% if row.IsPartner %}
                  <span style="color: #28a745; font-weight: 600;">Yes</span>
                {% else %}
                  <span style="color: #666;">No</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Pagination Controls -->
  {% if total_pages and total_pages > 1 %}
  <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; padding: 1rem; background: #f8f9fb; border-radius: 8px;">
    <div style="color: #666; font-size: 0.9rem;">
      Showing {{ ((page - 1) * per_page) + 1 }} to {{ [page * per_page, total_universities]|min }} of {{ total_universities }} universities
      <span style="color: #999;">({{ total_count }} total programs)</span>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
      {% if page > 1 %}
      <a href="{{ url_for('forms.yocket_programs_list', page=1, per_page=per_page, search=search_query) }}" 
         style="padding: 0.5rem 1rem; background: #2f4f8f; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600;">
        First
      </a>
      <a href="{{ url_for('forms.yocket_programs_list', page=page-1, per_page=per_page, search=search_query) }}" 
         style="padding: 0.5rem 1rem; background: #2f4f8f; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600;">
        Previous
      </a>
      {% else %}
      <span style="padding: 0.5rem 1rem; background: #ccc; color: #666; border-radius: 6px; cursor: not-allowed;">First</span>
      <span style="padding: 0.5rem 1rem; background: #ccc; color: #666; border-radius: 6px; cursor: not-allowed;">Previous</span>
      {% endif %}
      
      <span style="padding: 0.5rem 1rem; background: #eef3ff; color: #1d2e53; border-radius: 6px; font-weight: 600;">
        Page {{ page }} of {{ total_pages }}
      </span>
      
      {% if page < total_pages %}
      <a href="{{ url_for('forms.yocket_programs_list', page=page+1, per_page=per_page, search=search_query) }}" 
         style="padding: 0.5rem 1rem; background: #2f4f8f; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600;">
        Next
      </a>
      <a href="{{ url_for('forms.yocket_programs_list', page=total_pages, per_page=per_page, search=search_query) }}" 
         style="padding: 0.5rem 1rem; background: #2f4f8f; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600;">
        Last
      </a>
      {% else %}
      <span style="padding: 0.5rem 1rem; background: #ccc; color: #666; border-radius: 6px; cursor: not-allowed;">Next</span>
      <span style="padding: 0.5rem 1rem; background: #ccc; color: #666; border-radius: 6px; cursor: not-allowed;">Last</span>
      {% endif %}
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <label for="per_page" style="font-size: 0.9rem; color: #666;">Universities per page:</label>
      <select id="per_page" onchange="window.location.href='{{ url_for('forms.yocket_programs_list', page=1, search=search_query) }}&per_page=' + this.value" 
              style="padding: 0.4rem; border: 1px solid #d7dff3; border-radius: 6px;">
        <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
      </select>
    </div>
  </div>
  {% endif %}
  {% endif %}
</section>
{% endblock %}

