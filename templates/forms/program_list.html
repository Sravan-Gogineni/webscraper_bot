{% extends "base.html" %}
{% block title %}Programs | OneGrad{% endblock %}
{% block content %}
<section class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h2 style="margin: 0;">Programs</h2>
      <p style="margin: 0.25rem 0 0;">Maintain program offerings, requirements, and term details.</p>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <a
        href="{{ url_for('forms.program_create') }}"
        style="
          background: linear-gradient(135deg, #2f4f8f, #4068c6);
          color: #ffffff;
          padding: 0.75rem 1.3rem;
          border-radius: 8px;
          font-weight: 600;
          text-decoration: none;
          box-shadow: 0 10px 18px rgba(29, 46, 83, 0.2);
        "
        >Add Program</a
      >
    </div>
  </div>
  
  <!-- Bulk Actions Form -->
  {% if rows %}
  <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fb; border: 1px solid #d7dff3; border-radius: 8px;">
    <form method="post" action="{{ url_for('forms.bulk_update_program_college') }}" id="bulk-update-form" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 1rem;">
      <div style="flex: 1; min-width: 200px;">
        <label for="new_college_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1d2e53;">Change University for Selected Programs:</label>
        <select id="new_college_id" name="college_id" required style="width: 100%; min-height: 36px; padding: 0.5rem; border: 1px solid #d7dff3; border-radius: 6px;">
          <option value="">— Select University —</option>
          {% for cid, label in college_options %}
          <option value="{{ cid }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" id="bulk-update-btn" disabled style="background: #2f4f8f; color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.5;">
          Update Selected Programs
        </button>
      </div>
    </form>
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid #e4e9f5;">
      <form method="post" action="{{ url_for('forms.bulk_delete_programs') }}" id="bulk-delete-form" style="display: inline;">
        <button type="submit" id="bulk-delete-btn" disabled style="background: #dc3545; color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.5;">
          Delete Selected Programs
        </button>
      </form>
      <div style="color: #7b86aa; font-size: 0.9rem;">
        <span id="selected-count">0</span> program(s) selected
      </div>
    </div>
  </div>
  
  <!-- Quick Assign Unassigned Programs -->
  {% if "Unassigned" in grouped_programs %}
  <div style="margin-top: 1rem; padding: 1rem; background: #fff9e6; border: 2px solid #ffc107; border-radius: 8px;">
    <form method="post" action="{{ url_for('forms.bulk_update_program_college') }}" id="quick-assign-form" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label for="quick_assign_college_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #856404;">
          Quick Assign All Unassigned Programs:
        </label>
        <select id="quick_assign_college_id" name="college_id" required style="width: 100%; min-height: 36px; padding: 0.5rem; border: 1px solid #ffc107; border-radius: 6px;">
          <option value="">— Select University —</option>
          {% for cid, label in college_options %}
          <option value="{{ cid }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" style="background: #ffc107; color: #000; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
          Assign All Unassigned Programs
        </button>
      </div>
      <div style="color: #856404; font-size: 0.9rem;">
        {{ grouped_programs.get("Unassigned", [])|length }} unassigned program(s)
      </div>
    </form>
  </div>
  {% endif %}
  {% endif %}
  {% if not grouped_programs or not rows %}
  <p style="margin-top: 1.5rem;">No programs found.</p>
  {% else %}
  <div style="margin-top: 2rem;">
    {% for college_name, program_rows in grouped_programs.items() %}
    <!-- University Section -->
    <div class="university-section" data-college-name="{{ college_name }}" style="background: #f8f9fb; border: 2px solid #3e6acb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <h3 style="margin: 0 0 1rem 0; color: #1d2e53; font-size: 1.2rem; font-weight: 700;">
        {{ college_name }}
      </h3>
      <p style="margin: 0 0 1rem 0; color: #7b86aa; font-size: 0.9rem;">
        {{ program_rows|length }} program{{ 's' if program_rows|length != 1 else '' }}
      </p>
      
      <!-- Programs Table for this University -->
      <div style="overflow-x: auto;">
        <table
          class="programs-table"
          style="
            width: 100%;
            border-collapse: collapse;
            min-width: 820px;
            font-size: 0.95rem;
            background: #ffffff;
            border-radius: 6px;
            overflow: hidden;
          "
        >
          <thead>
            <tr style="background-color: #eef3ff; text-align: left;">
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3; width: 40px;">
                <input type="checkbox" class="select-all-checkbox" title="Select all programs in this section">
              </th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Program</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Level</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Concentration</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Department</th>
              <th style="padding: 0.75rem; border-bottom: 1px solid #d7dff3;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in program_rows %}
            <tr style="border-bottom: 1px solid #e4e9f5;">
              <td style="padding: 0.65rem;">
                <input type="checkbox" name="program_ids" value="{{ row.ProgramID }}" class="program-checkbox">
              </td>
              <td style="padding: 0.65rem; font-weight: 600;">{{ row.ProgramName or ("Program #" ~ row.ProgramID) }}</td>
              <td style="padding: 0.65rem;">{{ row.Level or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.Concentration or "—" }}</td>
              <td style="padding: 0.65rem;">{{ row.DepartmentName or "—" }}</td>
              <td style="padding: 0.65rem; white-space: nowrap;">
                <a href="{{ url_for('forms.program_edit', program_id=row.ProgramID) }}" style="margin-right: 1rem;">Edit</a>
                <form method="post" action="{{ url_for('forms.program_delete', program_id=row.ProgramID) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this program? This action cannot be undone.');">
                  <button type="submit" style="background: #dc3545; color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</section>

<script>
  // Handle select all checkboxes
  document.querySelectorAll('.select-all-checkbox').forEach(selectAll => {
    selectAll.addEventListener('change', function() {
      const table = this.closest('table');
      const checkboxes = table.querySelectorAll('.program-checkbox');
      checkboxes.forEach(cb => cb.checked = this.checked);
      updateSelectedCount();
    });
  });

  // Handle individual checkboxes
  document.querySelectorAll('.program-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });

  function updateSelectedCount() {
    const selected = document.querySelectorAll('.program-checkbox:checked').length;
    document.getElementById('selected-count').textContent = selected;
    
    const updateBtn = document.getElementById('bulk-update-btn');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    
    if (updateBtn) {
      updateBtn.disabled = selected === 0;
      updateBtn.style.opacity = selected === 0 ? '0.5' : '1';
    }
    
    if (deleteBtn) {
      deleteBtn.disabled = selected === 0;
      deleteBtn.style.opacity = selected === 0 ? '0.5' : '1';
    }
  }

  function getSelectedProgramIds() {
    const checkboxes = document.querySelectorAll('.program-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  function populateFormInputs(formId, programIds) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    // Remove existing hidden inputs
    form.querySelectorAll('input[name="program_ids"]').forEach(input => input.remove());
    
    // Add new hidden inputs for each program ID
    programIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'program_ids';
      input.value = id;
      form.appendChild(input);
    });
  }

  // Handle bulk update form submission
  document.getElementById('bulk-update-form')?.addEventListener('submit', function(e) {
    const programIds = getSelectedProgramIds();
    if (programIds.length === 0) {
      e.preventDefault();
      alert('Please select at least one program to update.');
      return false;
    }
    
    // Populate form with selected program IDs
    populateFormInputs('bulk-update-form', programIds);
    
    if (!confirm(`Are you sure you want to change the university for ${programIds.length} program(s)?`)) {
      e.preventDefault();
      return false;
    }
  });

  // Handle bulk delete form submission
  document.getElementById('bulk-delete-form')?.addEventListener('submit', function(e) {
    const programIds = getSelectedProgramIds();
    if (programIds.length === 0) {
      e.preventDefault();
      alert('Please select at least one program to delete.');
      return false;
    }
    
    // Populate form with selected program IDs
    populateFormInputs('bulk-delete-form', programIds);
    
    const count = programIds.length;
    const message = count === 1 
      ? 'Are you sure you want to delete this program? This action cannot be undone.'
      : `Are you sure you want to delete ${count} program(s)? This action cannot be undone.`;
    
    if (!confirm(message)) {
      e.preventDefault();
      return false;
    }
  });

  // Handle quick assign form - select all unassigned programs
  document.getElementById('quick-assign-form')?.addEventListener('submit', function(e) {
    // Find the unassigned section using data attribute
    const unassignedSection = document.querySelector('.university-section[data-college-name="Unassigned"]');
    
    if (!unassignedSection) {
      e.preventDefault();
      alert('No unassigned programs found. Please use the checkboxes to select programs manually.');
      return false;
    }
    
    const checkboxes = unassignedSection.querySelectorAll('.program-checkbox');
    const programIds = Array.from(checkboxes).map(cb => cb.value).filter(id => id);
    
    if (programIds.length === 0) {
      e.preventDefault();
      alert('No unassigned programs to assign.');
      return false;
    }
    
    // Populate form with program IDs
    populateFormInputs('quick-assign-form', programIds);
    
    const collegeId = document.getElementById('quick_assign_college_id').value;
    if (!collegeId) {
      e.preventDefault();
      alert('Please select a university.');
      return false;
    }
    
    if (!confirm(`Are you sure you want to assign all ${programIds.length} unassigned program(s) to the selected university?`)) {
      e.preventDefault();
      return false;
    }
  });
</script>
{% endblock %}


