{% extends "base.html" %}
{% block title %}Programs | OneGrad{% endblock %}
{% block extra_head %}
<style>
  .programs-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #e4e9f5;
  }
  
  .programs-header-info h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.75rem;
    color: #1d2e53;
    font-weight: 700;
  }
  
  .programs-header-info p {
    margin: 0;
    color: #7b86aa;
    font-size: 0.95rem;
  }
  
  .programs-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .stat-badge {
    background: linear-gradient(135deg, #eef3ff, #f8f9fb);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #2f4f8f;
    border: 1px solid #d7dff3;
  }
  
  .search-filters-container {
    background: linear-gradient(135deg, #f8f9fb, #ffffff);
    border: 1px solid #d7dff3;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(29, 46, 83, 0.08);
  }
  
  .search-box-wrapper {
    position: relative;
    margin-bottom: 1rem;
  }
  
  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #7b86aa;
    font-size: 1.2rem;
  }
  
  .search-input {
    width: 100%;
    padding: 0.9rem 1rem 0.9rem 3rem;
    border: 2px solid #d7dff3;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(29, 46, 83, 0.05);
  }
  
  .search-input:focus {
    outline: none;
    border-color: #3e6acb;
    box-shadow: 0 0 0 4px rgba(62, 106, 203, 0.1);
  }
  
  .filters-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  
  .filter-group {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #1d2e53;
    font-size: 0.9rem;
  }
  
  .filter-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #d7dff3;
    border-radius: 8px;
    font-size: 0.95rem;
    background: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .filter-select:focus {
    outline: none;
    border-color: #3e6acb;
    box-shadow: 0 0 0 3px rgba(62, 106, 203, 0.1);
  }
  
  .clear-filters-btn {
    padding: 0.75rem 1.5rem;
    background: #ffffff;
    border: 2px solid #d7dff3;
    border-radius: 8px;
    font-weight: 600;
    color: #7b86aa;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  
  .clear-filters-btn:hover {
    background: #f8f9fb;
    border-color: #3e6acb;
    color: #3e6acb;
  }
  
  .results-summary {
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    background: #e8f1ff;
    border-left: 4px solid #3e6acb;
    border-radius: 6px;
    color: #1d2e53;
    font-weight: 500;
  }
  
  .results-summary.hidden {
    display: none;
  }
  
  .university-section {
    background: #ffffff;
    border: 2px solid #e4e9f5;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(29, 46, 83, 0.08);
    transition: all 0.3s ease;
  }
  
  .university-section:hover {
    box-shadow: 0 6px 20px rgba(29, 46, 83, 0.12);
    border-color: #d7dff3;
  }
  
  .university-section.hidden {
    display: none;
  }
  
  .university-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eef3ff;
  }
  
  .university-name {
    margin: 0;
    color: #1d2e53;
    font-size: 1.3rem;
    font-weight: 700;
  }
  
  .university-count {
    background: linear-gradient(135deg, #3e6acb, #2f4f8f);
    color: #ffffff;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .programs-table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
  }
  
  .programs-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 920px;
    font-size: 0.95rem;
    background: #ffffff;
  }
  
  .programs-table thead {
    background: linear-gradient(135deg, #eef3ff, #f8f9fb);
  }
  
  .programs-table th {
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 700;
    color: #1d2e53;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #d7dff3;
  }
  
  .programs-table th:first-child {
    width: 50px;
    padding-left: 1rem;
  }
  
  .programs-table tbody tr {
    border-bottom: 1px solid #eef3ff;
    transition: background-color 0.2s ease;
  }
  
  .programs-table tbody tr:hover {
    background-color: #f8f9fb;
  }
  
  .programs-table tbody tr.hidden {
    display: none;
  }
  
  .programs-table td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
  }
  
  .programs-table td:first-child {
    padding-left: 1rem;
  }
  
  .program-name {
    font-weight: 600;
    color: #1d2e53;
  }
  
  .program-level {
    padding: 0.25rem 0.75rem;
    background: #eef3ff;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #2f4f8f;
    display: inline-block;
  }
  
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .action-link {
    color: #3e6acb;
    text-decoration: none;
    font-weight: 600;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }
  
  .action-link:hover {
    background: #eef3ff;
    color: #2f4f8f;
  }
  
  .action-delete-btn {
    background: #ffe7e7;
    color: #dc3545;
    border: 1px solid #f5b5b8;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .action-delete-btn:hover {
    background: #dc3545;
    color: #ffffff;
  }
  
  .bulk-actions-panel {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fb, #ffffff);
    border: 1px solid #d7dff3;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(29, 46, 83, 0.08);
  }
  
  .bulk-actions-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e4e9f5;
  }
  
  .bulk-actions-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  
  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: #7b86aa;
    font-size: 1.1rem;
  }
  
  .no-results-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  @media (max-width: 768px) {
    .programs-header {
      flex-direction: column;
    }
    
    .search-filters-container {
      padding: 1rem;
    }
    
    .filters-row {
      flex-direction: column;
    }
    
    .filter-group {
      min-width: 100%;
    }
  }
</style>
{% endblock %}
{% block content %}
<section class="card">
  <div class="programs-header">
    <div class="programs-header-info">
      <h2>Programs</h2>
      <p>Manage program offerings, requirements, and term details across universities</p>
    </div>
    <div class="programs-stats">
      <div class="stat-badge">
        <span id="total-programs-count">{{ total_programs if total_programs is defined else (rows|length if rows else 0) }}</span> Total Programs
        {% if total_universities is defined %}
        <span style="margin-left: 0.5rem; opacity: 0.7;">‚Ä¢ {{ total_universities }} Universit{{ 'y' if total_universities == 1 else 'ies' }}</span>
        {% endif %}
      </div>
      <a
        href="{{ url_for('forms.program_create') }}"
        style="
          background: linear-gradient(135deg, #2f4f8f, #4068c6);
          color: #ffffff;
          padding: 0.75rem 1.5rem;
          border-radius: 8px;
          font-weight: 600;
          text-decoration: none;
          box-shadow: 0 4px 12px rgba(29, 46, 83, 0.2);
          transition: transform 0.2s ease;
          display: inline-block;
        "
        onmouseover="this.style.transform='translateY(-2px)'"
        onmouseout="this.style.transform='translateY(0)'"
        >+ Add Program</a
      >
    </div>
  </div>
  
  <!-- Search and Filters -->
  {% if rows %}
  <div class="search-filters-container">
    <div class="search-box-wrapper">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="Search programs by name, level, school, concentration, department, or university..."
      />
    </div>
    <div class="filters-row">
      <div class="filter-group">
        <label for="filter-university">Filter by University:</label>
        <select id="filter-university" class="filter-select">
          <option value="">All Universities</option>
          {% for college_name in grouped_programs.keys() %}
          <option value="{{ college_name }}">{{ college_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-level">Filter by Level:</label>
        <select id="filter-level" class="filter-select">
          <option value="">All Levels</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-department">Filter by Department:</label>
        <select id="filter-department" class="filter-select">
          <option value="">All Departments</option>
        </select>
      </div>
      <button type="button" class="clear-filters-btn" id="clear-filters-btn">Clear Filters</button>
    </div>
    <div class="results-summary hidden" id="results-summary"></div>
  </div>
  
  <!-- Bulk Actions Form -->
  <div class="bulk-actions-panel">
    <div class="bulk-actions-section">
      <form method="post" action="{{ url_for('forms.bulk_update_program_college') }}" id="bulk-update-form" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label for="new_college_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1d2e53;">Change University for Selected Programs:</label>
          <select id="new_college_id" name="college_id" required style="width: 100%; padding: 0.75rem; border: 2px solid #d7dff3; border-radius: 8px; font-size: 0.95rem;">
            <option value="">‚Äî Select University ‚Äî</option>
            {% for cid, label in college_options %}
            <option value="{{ cid }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <button type="submit" id="bulk-update-btn" disabled style="background: #2f4f8f; color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;">
            Update Selected Programs
          </button>
        </div>
      </form>
    </div>
    <div class="bulk-actions-section" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <form method="post" action="{{ url_for('forms.bulk_delete_programs') }}" id="bulk-delete-form" style="display: inline;">
        <button type="submit" id="bulk-delete-btn" disabled style="background: #dc3545; color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;">
          Delete Selected Programs
        </button>
      </form>
      <div style="color: #7b86aa; font-size: 0.9rem;">
        <span id="selected-count">0</span> program(s) selected
      </div>
    </div>
    <div class="bulk-actions-section" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <form method="post" action="{{ url_for('forms.clear_all_program_schools') }}" id="clear-schools-form" style="display: inline;">
        <button type="submit" style="background: #ffc107; color: #000; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="return confirm('‚ö†Ô∏è WARNING: This will clear the School field for ALL programs in the database. This action cannot be undone. Are you sure you want to continue?');">
          Clear All School Data
        </button>
      </form>
      <div style="color: #7b86aa; font-size: 0.9rem;">
        Removes School field value for all programs
      </div>
    </div>
    <!-- Fix Department Assignments -->
    <div class="bulk-actions-section" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; padding: 1rem; border: 2px solid #3e6acb; background: #eef3ff; border-radius: 8px;">
      <form method="post" action="{{ url_for('forms.fix_program_department_assignments') }}" id="fix-departments-form" style="display: inline;">
        <button type="submit" style="background: linear-gradient(135deg, #3e6acb, #2f4f8f); color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="return confirm('This will reassign ALL program departments based on each program\\'s college from ProgramTermDetails.\n\nIt will:\n- Match departments to programs based on their college\n- Prefer Graduate/Undergraduate Admissions departments based on program level\n- Update or create ProgramDepartmentLink records\n\nThis action will affect ALL programs in the database.\n\nContinue?');">
          Fix All Department Assignments
        </button>
      </form>
      <div style="color: #1d2e53; font-size: 0.9rem; font-weight: 600;">
        üîß Reassigns all program departments to match their correct college/university
      </div>
    </div>
    <!-- Delete All Programs -->
    <div class="bulk-actions-section" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; padding: 1rem; border: 2px solid #dc3545; background: #fff5f5; border-radius: 8px;">
      <form method="post" action="{{ url_for('forms.delete_all_programs') }}" id="delete-all-programs-form" style="display: inline;">
        <button type="submit" style="background: #dc3545; color: #ffffff; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="return confirm('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nThis will PERMANENTLY DELETE ALL PROGRAMS and ALL related records (requirements, test scores, term details, department links) from the database.\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to delete ALL programs?');">
          Delete All Programs
        </button>
      </form>
      <div style="color: #dc3545; font-size: 0.9rem; font-weight: 600;">
        ‚ö†Ô∏è Permanently deletes ALL programs and related data
      </div>
    </div>
  </div>
  
  <!-- Quick Assign Unassigned Programs -->
  {% if "Unassigned" in grouped_programs %}
  <div style="margin-top: 1.5rem; padding: 1.5rem; background: #fff9e6; border: 2px solid #ffc107; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
    <form method="post" action="{{ url_for('forms.bulk_update_program_college') }}" id="quick-assign-form" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label for="quick_assign_college_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #856404;">
          Quick Assign All Unassigned Programs:
        </label>
        <select id="quick_assign_college_id" name="college_id" required style="width: 100%; padding: 0.75rem; border: 2px solid #ffc107; border-radius: 8px; font-size: 0.95rem;">
          <option value="">‚Äî Select University ‚Äî</option>
          {% for cid, label in college_options %}
          <option value="{{ cid }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" style="background: #ffc107; color: #000; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          Assign All Unassigned Programs
        </button>
      </div>
      <div style="color: #856404; font-size: 0.9rem; font-weight: 600;">
        {{ grouped_programs.get("Unassigned", [])|length }} unassigned program(s)
      </div>
    </form>
  </div>
  {% endif %}
  {% endif %}
  
  {% if not grouped_programs or not rows %}
  <div class="no-results">
    <div class="no-results-icon">üìã</div>
    <p>No programs found.</p>
  </div>
  {% else %}
  <div id="programs-container" style="margin-top: 2rem;">
    {% for college_name, program_rows in grouped_programs.items() %}
    <!-- University Section -->
    <div class="university-section" data-college-name="{{ college_name }}">
      <div class="university-header">
        <h3 class="university-name">{{ college_name }}</h3>
        <div class="university-count">{{ program_rows|length }} program{{ 's' if program_rows|length != 1 else '' }}</div>
      </div>
      
      <!-- Programs Table for this University -->
      <div class="programs-table-wrapper">
        <table class="programs-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" class="select-all-checkbox" title="Select all programs in this section">
              </th>
              <th>Program</th>
              <th>Level</th>
              <th>School</th>
              <th>Concentration</th>
              <th>Department</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in program_rows %}
            <tr
              data-program-name="{{ (row.ProgramName or 'Program #' ~ row.ProgramID)|lower }}"
              data-level="{{ (row.Level or '')|lower }}"
              data-school="{{ (row.School or '')|lower }}"
              data-concentration="{{ (row.Concentration or '')|lower }}"
              data-department="{{ (row.DepartmentName or '')|lower }}"
              data-college-name="{{ college_name|lower }}"
              data-college-dept-id="{{ row.CollegeDepartmentID or '' }}"
              data-dept-id="{{ row.DepartmentID or '' }}"
            >
              <td>
                <input type="checkbox" name="program_ids" value="{{ row.ProgramID }}" class="program-checkbox">
              </td>
              <td>
                <span class="program-name">{{ row.ProgramName or ("Program #" ~ row.ProgramID) }}</span>
              </td>
              <td>
                {% if row.Level %}
                <span class="program-level">{{ row.Level }}</span>
                {% else %}
                <span style="color: #7b86aa;">‚Äî</span>
                {% endif %}
              </td>
              <td>{{ row.School or "‚Äî" }}</td>
              <td>{{ row.Concentration or "‚Äî" }}</td>
              <td>
                {% if row.DepartmentName %}
                {{ row.DepartmentName }}
                {% else %}
                ‚Äî
                {% endif %}
              </td>
              <td>
                <div class="action-buttons">
                  <a href="{{ url_for('forms.program_edit', program_id=row.ProgramID) }}" class="action-link">Edit</a>
                  <form method="post" action="{{ url_for('forms.program_delete', program_id=row.ProgramID) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this program? This action cannot be undone.');">
                    <button type="submit" class="action-delete-btn">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</section>

<script>
  // Collect all unique levels and departments for filters
  const allPrograms = [];
  document.querySelectorAll('tbody tr').forEach(tr => {
    const level = tr.dataset.level.trim();
    const department = tr.dataset.department.trim();
    allPrograms.push({
      level: level || null,
      department: department || null
    });
  });
  
  const uniqueLevels = [...new Set(allPrograms.map(p => p.level).filter(Boolean))].sort();
  const uniqueDepartments = [...new Set(allPrograms.map(p => p.department).filter(Boolean))].sort();
  
  // Populate level filter
  const levelFilter = document.getElementById('filter-level');
  uniqueLevels.forEach(level => {
    const option = document.createElement('option');
    option.value = level;
    option.textContent = level.charAt(0).toUpperCase() + level.slice(1);
    levelFilter.appendChild(option);
  });
  
  // Populate department filter
  const departmentFilter = document.getElementById('filter-department');
  uniqueDepartments.forEach(dept => {
    const option = document.createElement('option');
    option.value = dept;
    option.textContent = dept;
    departmentFilter.appendChild(option);
  });
  
  // Search and filter functionality
  const searchInput = document.getElementById('search-input');
  const universityFilter = document.getElementById('filter-university');
  const clearFiltersBtn = document.getElementById('clear-filters-btn');
  const resultsSummary = document.getElementById('results-summary');
  
  function filterPrograms() {
    const searchTerm = (searchInput.value || '').toLowerCase().trim();
    const selectedUniversity = (universityFilter.value || '').toLowerCase();
    const selectedLevel = (levelFilter.value || '').toLowerCase();
    const selectedDepartment = (departmentFilter.value || '').toLowerCase();
    
    let visibleCount = 0;
    let visibleUniversities = 0;
    
    document.querySelectorAll('.university-section').forEach(section => {
      const collegeName = section.dataset.collegeName.toLowerCase();
      let sectionVisible = false;
      let sectionCount = 0;
      
      section.querySelectorAll('tbody tr').forEach(tr => {
        const programName = tr.dataset.programName || '';
        const level = tr.dataset.level || '';
        const school = tr.dataset.school || '';
        const concentration = tr.dataset.concentration || '';
        const department = tr.dataset.department || '';
        const trCollegeName = tr.dataset.collegeName || '';
        
        // Check search term
        const matchesSearch = !searchTerm || 
          programName.includes(searchTerm) ||
          level.includes(searchTerm) ||
          school.includes(searchTerm) ||
          concentration.includes(searchTerm) ||
          department.includes(searchTerm) ||
          trCollegeName.includes(searchTerm);
        
        // Check filters
        const matchesUniversity = !selectedUniversity || collegeName === selectedUniversity;
        const matchesLevel = !selectedLevel || level === selectedLevel;
        const matchesDepartment = !selectedDepartment || department === selectedDepartment;
        
        if (matchesSearch && matchesUniversity && matchesLevel && matchesDepartment) {
          tr.classList.remove('hidden');
          sectionVisible = true;
          sectionCount++;
          visibleCount++;
        } else {
          tr.classList.add('hidden');
        }
      });
      
      // Show/hide university section
      if (sectionVisible) {
        section.classList.remove('hidden');
        // Update count in header
        const countBadge = section.querySelector('.university-count');
        if (countBadge) {
          countBadge.textContent = `${sectionCount} program${sectionCount !== 1 ? 's' : ''}`;
        }
        visibleUniversities++;
      } else {
        section.classList.add('hidden');
      }
    });
    
    // Update results summary
    const totalPrograms = {{ total_programs if total_programs is defined else (rows|length if rows else 0) }};
    if (searchTerm || selectedUniversity || selectedLevel || selectedDepartment) {
      resultsSummary.classList.remove('hidden');
      resultsSummary.textContent = `Showing ${visibleCount} of ${totalPrograms} program${totalPrograms !== 1 ? 's' : ''} across ${visibleUniversities} universit${visibleUniversities !== 1 ? 'ies' : 'y'}`;
    } else {
      resultsSummary.classList.add('hidden');
    }
  }
  
  // Event listeners
  searchInput.addEventListener('input', filterPrograms);
  universityFilter.addEventListener('change', filterPrograms);
  levelFilter.addEventListener('change', filterPrograms);
  departmentFilter.addEventListener('change', filterPrograms);
  
  clearFiltersBtn.addEventListener('click', () => {
    searchInput.value = '';
    universityFilter.value = '';
    levelFilter.value = '';
    departmentFilter.value = '';
    filterPrograms();
  });
  
  // Handle select all checkboxes
  document.querySelectorAll('.select-all-checkbox').forEach(selectAll => {
    selectAll.addEventListener('change', function() {
      const table = this.closest('table');
      const checkboxes = table.querySelectorAll('.program-checkbox:not([style*="display: none"])');
      const visibleCheckboxes = Array.from(checkboxes).filter(cb => !cb.closest('tr').classList.contains('hidden'));
      visibleCheckboxes.forEach(cb => cb.checked = this.checked);
      updateSelectedCount();
    });
  });
  
  // Handle individual checkboxes
  document.querySelectorAll('.program-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });
  
  function updateSelectedCount() {
    const selected = document.querySelectorAll('.program-checkbox:checked').length;
    const countElement = document.getElementById('selected-count');
    if (countElement) {
      countElement.textContent = selected;
    }
    
    const updateBtn = document.getElementById('bulk-update-btn');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    
    if (updateBtn) {
      updateBtn.disabled = selected === 0;
      updateBtn.style.opacity = selected === 0 ? '0.5' : '1';
      updateBtn.style.cursor = selected === 0 ? 'not-allowed' : 'pointer';
    }
    
    if (deleteBtn) {
      deleteBtn.disabled = selected === 0;
      deleteBtn.style.opacity = selected === 0 ? '0.5' : '1';
      deleteBtn.style.cursor = selected === 0 ? 'not-allowed' : 'pointer';
    }
  }
  
  function getSelectedProgramIds() {
    const checkboxes = document.querySelectorAll('.program-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }
  
  function populateFormInputs(formId, programIds) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    // Remove existing hidden inputs
    form.querySelectorAll('input[name="program_ids"]').forEach(input => input.remove());
    
    // Add new hidden inputs for each program ID
    programIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'program_ids';
      input.value = id;
      form.appendChild(input);
    });
  }
  
  // Handle bulk update form submission
  document.getElementById('bulk-update-form')?.addEventListener('submit', function(e) {
    const programIds = getSelectedProgramIds();
    if (programIds.length === 0) {
      e.preventDefault();
      alert('Please select at least one program to update.');
      return false;
    }
    
    populateFormInputs('bulk-update-form', programIds);
    
    if (!confirm(`Are you sure you want to change the university for ${programIds.length} program(s)?`)) {
      e.preventDefault();
      return false;
    }
  });
  
  // Handle bulk delete form submission
  document.getElementById('bulk-delete-form')?.addEventListener('submit', function(e) {
    const programIds = getSelectedProgramIds();
    if (programIds.length === 0) {
      e.preventDefault();
      alert('Please select at least one program to delete.');
      return false;
    }
    
    populateFormInputs('bulk-delete-form', programIds);
    
    const count = programIds.length;
    const message = count === 1 
      ? 'Are you sure you want to delete this program? This action cannot be undone.'
      : `Are you sure you want to delete ${count} program(s)? This action cannot be undone.`;
    
    if (!confirm(message)) {
      e.preventDefault();
      return false;
    }
  });
  
  // Handle quick assign form - select all unassigned programs
  document.getElementById('quick-assign-form')?.addEventListener('submit', function(e) {
    const unassignedSection = document.querySelector('.university-section[data-college-name="Unassigned"]');
    
    if (!unassignedSection) {
      e.preventDefault();
      alert('No unassigned programs found. Please use the checkboxes to select programs manually.');
      return false;
    }
    
    const checkboxes = unassignedSection.querySelectorAll('.program-checkbox');
    const programIds = Array.from(checkboxes).map(cb => cb.value).filter(id => id);
    
    if (programIds.length === 0) {
      e.preventDefault();
      alert('No unassigned programs to assign.');
      return false;
    }
    
    populateFormInputs('quick-assign-form', programIds);
    
    const collegeId = document.getElementById('quick_assign_college_id').value;
    if (!collegeId) {
      e.preventDefault();
      alert('Please select a university.');
      return false;
    }
    
    if (!confirm(`Are you sure you want to assign all ${programIds.length} unassigned program(s) to the selected university?`)) {
      e.preventDefault();
      return false;
    }
  });
  
  // Initialize
  updateSelectedCount();
</script>
{% endblock %}